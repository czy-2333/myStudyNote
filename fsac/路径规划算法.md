# 0. 车辆运动学自行车模型

运动学是从几何学的角度研究物体的运动规律，包括物体在空间的位置、速度等随时间而产生的变化

因此，车辆运动学模型能反映车辆位置、速度、加速度等与时间的关系

基于运动学模型设计出的控制器也能保证对车辆底层执行层下发的指令是符合车辆运动学约束的



对于运动学自行车模型，我们一般做出如下假设：

*   不引入任何会影响到车辆动作的力；
*   车辆只在 xy 平面上运动，在 z 轴（垂直方向）上的侧倾，前后俯仰等不考虑；
*   车辆结构就像自行车，左右前轮的转角和转速一致，后轮也是一样
    *   所以两个前轮和后轮各可只用一个轮胎来描述；（转向角较小的情况）
*   前后轮的各自速度矢量和各自轮胎朝向一致，即假设轮胎无侧滑；
*   而一般只有在低速状态下，轮胎产生的侧向力很小可忽略，所以该模型也主要应用于低速场景。







# 1. 纯跟踪算法 (Pure Pursuit)

## 1.1 概念

*   通过控制前轮转角来让后轮追踪下一个预瞄点，使车辆可以沿着经过目标预瞄点的圆弧行驶

![1](图片/1.png) 

| 符号     | 物理量             |
| :------- | :----------------- |
| R  (m)   | 转弯半径           |
| L  (m)   | 轴距               |
| δ  (rad) | 前轮转角           |
| α  (rad) | 车身与预瞄点夹角   |
| l~d~ (m) | 预瞄距离           |
| e  (m)   | 与预瞄点的横向偏差 |
| x~r~ (m) | 预瞄点横坐标       |
| y~r~ (m) | 预瞄点纵坐标       |







## 1.2 计算
###　0. 公式
$$
\color{#F00}{\LARGEδ=atan(\dfrac{2L*sinα}{l{_d}})}
$$





![2](图片/2.png) 



###　1. 求偏转角

  $∠AOC=π-∠OAC-∠OCA=π-2∠OAC=π-2(\dfrac{π}{2}-α)=2α$

  故有：

  $∠AOC=2α$



###　2. 转弯半径与预瞄距离之间的关系

 由正弦定理可得：

 $\dfrac{l{_d}}{sin2α}=\dfrac{R}{sin∠OAC}=\dfrac{R}{sin(\dfrac{π}{2}-α)}$

 $\dfrac{l{_d}}{2sinα*cosα}=\dfrac{R}{cosα}$

 化简得：

 $\dfrac{1}{R}=\dfrac{2sinα}{l{_d}}$



###　3. 求前轮转角

 联立可得：
$$
\begin{cases}\dfrac{1}{R}=\dfrac{2sinα}{l{_d}}\\tanδ=\dfrac{L}{R}\Longrightarrow δ=atan(\dfrac{L}{R})\end{cases}\Longrightarrow δ=atan(\dfrac{2L*sinα}{l{_d}})
$$



###　4. 求取各项参数

*   L为车身长,已知

 *   l~d~为预瞄距离

     为了让速度越大时所预瞄的距离越远，则有：(预瞄距离越短，精度越大)

     $l{_d}=k*v$      k为比例系数，v为当前速度

 *   α为与预瞄点之间的偏转角

     可通过AC与X轴的夹角与车身横摆角相减可得：(车身横摆角为AB与X轴夹角，为已知角)

     $α=∠CAD-∠BAD=atan(\dfrac{y{_r}-y}{x{_r}-x})-atan(\dfrac{y{_0}-y}{x{_0}-x})$

![3](图片/3.png) 



###　5. 对公式优化

 通过上述所求，可得：

 $δ=atan(\dfrac{2L*sinα}{k*v})$

​	问题 1：当初速度$v{_0}=0$时，该公式分母为0，容易让仿真报警

​	问题 2：当速度 v 很小时，速度小幅度的变化也会让 δ 变化很大

 故将公式优化为：

 $δ=atan(\dfrac{2L*sinα}{k*v+l{_0}})$		( 其中l~0~为常数项 )



###　6. 如何求预瞄点坐标

 ![4](图片/4.png)

 轨迹跟踪所只会提供一些离散的坐标点，这些坐标点位于规矩跟踪的黄色路径上，如何寻找预瞄点 C

 *   寻找与后轮中心 A 最近的匹配点 E 

 *   通过与匹配点 E 距离为 l~d~ 的近似点 F

 *   将近似点 F 当作 预瞄点 C 计算



注意：

*    l~d~太大：导致降低规矩追踪的精度		(导致跟踪路径上一些点丢失)
*    l~d~太小：导致追踪不稳定



###　7. 求横向误差

横向误差 e 为预瞄点到车辆所在直线的距离

![5](图片/5.png) 

$e=l{_d}*sinα$

在前轮转角 δ 趋近于0时有：		( arctan x 函数在趋近于0时，近似于 x )

$δ=atan(\dfrac{2L*sinα}{l{_d}})\Longrightarrow δ=\dfrac{2L*sinα}{l{_d}}\Longrightarrow sinα=\dfrac{δ*l{_d}}{2L}$

综上所述：

$e=\dfrac{δ*l{^2_d}}{2L}$





# 2. PID控制算法

PID控制算法是一种 闭环控制系统，也叫闭环回路 (Closed Loop)

以机器人为例：

1.开放回路

*   输入恒定，输入不会影响输出

<img src="图片/7.png" alt="7" style="zoom: 50%;" /> 





2.闭环回路

*   输入不在恒定，会根据输出来调整输入

<img src="图片/6.png" alt="6" style="zoom: 50%;" /> 







## 2.0 PID公式

C ：输出

T~p~：比例参数

e ：误差

T~i~ ：积分参数

T~d~：微分参数



不常用版本：
$$
\large{C=\dfrac{1}{T{_p}}(e+\dfrac{1}{T{_i}}\int_0^te*dt+T{_d}\dfrac{de}{dt})}
$$
连续版本：
$$
\color{red}\large{C=K{_p}*e+K{_i}*\int_0^te*dt+K{_d}*\dfrac{de}{dt}}
$$
离散版本：
$$
\color{red}\large{C=K{_p}*e{_i}+K{_i}*\sum\limits_{i=1}^Ne{_i}+K{_d}*(e{_i}-e{_{i-1}})}
$$


## 2.1 Proportional (比例)

以无人机为例：



1.控制无人机到达目标高度，需要提供一个升力来平衡重力和提供速度

2.通过计算目标高度和所在高度之差得到的误差 ( error )设置

3.使用 P算法 以误差的大小来设置升力大小，则有：$F{_p}=K{_p}*error$



K~p~ 为一个自定义的常量，是升力和误差的比例

*   K~p~ 越大控制系统的响应速度也越大，但接近目标高度之后产生的振荡 (在目标高度上下摆动) 也越大

![8](图片/8.png) 









## 2.2 Differential (微分)

为了减缓无人机的振荡，在计算中增加参数 K~d~



对误差进行微分可以得到速度，并通过 K~d~ 对速度进行控制：

$F{_d}=K{_d}*\dfrac{d(error)}{dt}$

D算法 可以可以对无人机的速度做出反应，d(error) 是一个负值，当速度过快时，将以减小升力的方法来减缓振荡

*   K~d~越大，对振荡的减缓 (阻尼) 就越明显，但K~d~过大会产生 过充 (overshoot) 的反效果，即超过目标高度

![10](图片/10.png) 









## 2.3 Integral (积分)

虽然加入了阻尼可以减缓振荡，但无人机最终会在误差很小的高度停下，因为此时升力和重力平衡，速度为0



为了让无人机到达目标高度，我们需要累计误差值，并转换成升力：

$F{_i}=K{_i}*\int_0^te*dt$

避免升力和阻力平衡导致的静止，但需要对 K~i~ 参数进行限制，防止速度越来越快

I算法 会对误差进行累计以此来提供更大的升力，加入 K~i~ 参数，最终使误差降为 0

![9](图片/9.png) 





*   无人机模拟网址：https://rossning92.github.io/pid-simulation/











# 3. Stanley算法











# 4. 横纵向控制

*   汽车的横向控制（ 横向控制参考PP算法和Stanley算法 ）
    *   通过方向盘转角来控制前轮转角

*   汽车的纵向控制
    *   通过油门和刹车来控制汽车速度



## 4.1 油门

根据油门的下压的比率，控制汽车功率，功率变化改变汽车的发动机转速扭矩使汽车加速变大，来实现汽车加速


$$
\large{P=F*v}\Longrightarrow P=F*r*\dfrac{v}{r}
$$

$$
\large{\begin{cases}F*r=M\\w=\dfrac{v}{r}\end{cases}\Longrightarrow P=M*w}
$$











# 5. Matlab

```matlab
clc							%清屏
clear						%清除变量
home						%光标移至第一行
plot(x,y)					%画图
figure						%产生新的画图结点
string('hello world')		%字符串定义
disp('hhh')					%打印类容
```



# 6.卡尔曼滤波

